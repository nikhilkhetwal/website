<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Festival Greetings - Elegant Wishes Creator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&family=Tangerine:wght@400;700&family=Prata&family=Bodoni+Moda:wght@400;600&family=Orbitron:wght@400;700;900&family=Abril+Fatface&family=Pacifico&family=Comfortaa:wght@400;700;900&family=Quicksand:wght@400;600;700&family=Nunito:wght@400;600;700&family=Varela+Round&family=Sora:wght@400;600;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --gold: #D4AF37;
            --dark: #1a1a2e;
            --darker: #0f0f1e;
            --light: #eee;
            --white: #ffffff;
            --accent: #c9a961;
            --text-light: #a0a0a0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--darker);
            color: var(--white);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background:
                radial-gradient(ellipse at top, rgba(212,175,55,0.15), transparent),
                radial-gradient(ellipse at bottom, rgba(201,169,97,0.1), transparent);
            pointer-events: none; z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        header { text-align: center; margin-bottom: 80px; animation: fadeInDown 1s ease; }

        .logo {
            font-family: 'Pacifico', cursive;
            font-size: clamp(2.5rem, 6vw, 4.5rem);
            background: linear-gradient(135deg, var(--gold), var(--accent), var(--gold));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; margin-bottom: 15px; letter-spacing: 2px;
            animation: shimmer 3s ease-in-out infinite;
        }
        @keyframes shimmer { 0%,100%{background-position:0% 50%}50%{background-position:100% 50%} }

        .tagline { font-size: clamp(1rem,2vw,1.3rem); color: var(--text-light); font-weight: 300; letter-spacing: 3px; text-transform: uppercase; }

        .divider { width: 100px; height: 2px; background: linear-gradient(90deg, transparent, var(--gold), transparent); margin: 30px auto; }

        .main-card {
            background: rgba(26,26,46,0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 30px;
            padding: 60px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
            animation: fadeInUp 1s ease;
        }

        .select-wrapper { position: relative; margin-bottom: 40px; }
        .select-label { display:block; font-family: 'Pacifico', cursive; font-size:1.4rem; color:var(--gold); margin-bottom:12px; }

        select {
            width:100%; padding:14px 44px 14px 18px;
            background: rgba(15,15,30,0.8);
            border:2px solid rgba(212,175,55,0.3);
            border-radius:12px; color:var(--white); font-size:1rem; font-family:'Inter',sans-serif;
            cursor:pointer; transition: all .3s ease; appearance:none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23D4AF37' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat:no-repeat; background-position:right 16px center; background-size:16px;
        }
        select:hover { border-color: var(--gold); box-shadow: 0 0 14px rgba(212,175,55,0.12); }
        select:focus { outline:none; border-color:var(--gold); box-shadow: 0 0 22px rgba(212,175,55,0.18); }
        option { background: var(--darker); padding: 10px; }

        .preview-section { margin: 40px 0; min-height: 420px; display:flex; align-items:center; justify-content:center; position:relative; }
        .preview-container { position: relative; max-width:600px; width:100%; border-radius:16px; overflow:hidden;
            box-shadow: 0 18px 50px rgba(0,0,0,0.55), 0 0 80px rgba(212,175,55,0.08); transition:all .35s ease; animation: fadeIn .4s ease; }
        .preview-container:hover { transform: translateY(-8px); box-shadow: 0 26px 60px rgba(0,0,0,0.65), 0 0 100px rgba(212,175,55,0.12); }

        .preview-image { display:block; width:100%; height:auto; }

        /* Overlay — top is set by JS as percentage of image height */
        .text-overlay {
            position: absolute;
            left: 50%;
            width: 85%;
            text-align: center;
            color: var(--darker);
            font-family: 'Quicksand', sans-serif;
            font-weight: 700;
            line-height: 1.4;
            word-wrap: break-word;
            text-shadow: 0 2px 4px rgba(255,255,255,0.28);
            transform: translateX(-50%); /* JS will add vertical translate to center at the anchor */
            pointer-events: none;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .placeholder { text-align:center; padding:80px 24px; color:var(--text-light); }
        .placeholder-icon { font-size:4rem; margin-bottom:20px; opacity:0.3; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-18px) } }
        .placeholder-text { font-family: 'Playfair Display', serif; font-size:1.25rem; color:var(--gold); margin-bottom:8px; }
        .placeholder-subtext { font-size:0.95rem; color:var(--text-light); }

        .input-section { margin:30px 0; position:relative; display:none; }
        .input-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        .input-label { display:block; font-family:'Pacifico',cursive; font-size:1.15rem; color:var(--gold); }

        /* container to push controls to right */
        .input-header > div {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Responsive, smaller Text Color button */
        .color-picker-btn {
            background: transparent;
            border: 2px solid rgba(212,175,55,0.22);
            color: var(--gold);
            padding: clamp(6px, 0.8vw, 8px) clamp(10px, 1.8vw, 12px);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: clamp(0.78rem, 1.6vw, 0.92rem);
            transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .color-picker-btn:hover {
            transform: translateY(-2px);
            border-color: var(--gold);
            box-shadow: 0 6px 16px rgba(212,175,55,0.10);
        }

        /* Small color swatch inside button (optional visual cue) */
        .color-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2) inset;
        }

        .font-picker-btn { background:none; border:none; cursor:pointer; font-size:1.6rem; color:var(--gold); display:flex; align-items:center; justify-content:center; }
        .font-picker-btn:hover { transform: scale(1.1); filter:brightness(1.15); }

        .color-palette { display:none; position:absolute; top:-440px; right:0; background: rgba(26,26,46,0.95); backdrop-filter: blur(18px); border:2px solid rgba(212,175,55,0.28); border-radius:12px; padding:14px; gap:10px; z-index:100; width:190px; grid-template-columns: repeat(3,1fr); box-shadow: 0 10px 36px rgba(0,0,0,0.45); }
        .color-palette.show { display:grid; }
        .color-option { width:40px; height:40px; border-radius:50%; border:2px solid rgba(255,255,255,0.45); cursor:pointer; transition:all .16s ease; }
        .color-option:hover { transform:scale(1.08); border-color:var(--white); }
        .color-option.active { border-color:var(--gold); box-shadow: 0 0 12px rgba(212,175,55,0.55); }

        textarea {
            width:100%; padding:18px; background: rgba(15,15,30,0.85); border:2px solid rgba(212,175,55,0.22);
            border-radius:12px; color:var(--white); font-size:1.25rem; font-family:'Quicksand',sans-serif; font-weight:700; resize:vertical; min-height:110px;
            transition: all .3s ease;
        }
        textarea::placeholder { color:var(--text-light); font-style:italic; }
        .char-count { text-align:right; margin-top:8px; font-size:0.88rem; color:var(--text-light); }
        .char-count span { color:var(--gold); font-weight:600; }

        .button-group { display:flex; gap:12px; margin-top:30px; flex-wrap:wrap; }
        button { flex:1; min-width:160px; padding:12px 28px; border:none; border-radius:12px; font-size:0.95rem; font-weight:700; text-transform:uppercase; letter-spacing:1.8px; cursor:pointer; transition:all .3s ease; position:relative; overflow:hidden; }
        button::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background: rgba(255,255,255,0.06); transform:translate(-50%,-50%); transition: width .4s, height .4s; }
        button:hover::before { width:260px; height:260px; }
        .btn-primary { background: linear-gradient(135deg, var(--gold), var(--accent)); color:var(--darker); box-shadow: 0 8px 22px rgba(212,175,55,0.22); }
        .btn-secondary { background:transparent; color:var(--gold); border:2px solid var(--gold); }
        button:disabled { opacity:0.45; cursor:not-allowed; transform:none !important; }
        button span { position:relative; z-index:1; }

        .success-message { background: linear-gradient(135deg, rgba(212,175,55,0.18), rgba(201,169,97,0.12)); border:1px solid rgba(212,175,55,0.14); color:var(--gold); padding:14px; border-radius:12px; text-align:center; margin-top:18px; font-weight:600; display:none; animation:fadeInUp .35s ease; }
        .success-message.show { display:block; }
        .success-icon { font-size:1.1rem; margin-right:8px; }

        @keyframes fadeInDown { from { opacity:0; transform:translateY(-30px); } to { opacity:1; transform:translateY(0); } }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }

        /* Responsive tweaks */
        @media (max-width: 1024px) {
            .main-card { padding:36px 24px; }
            .logo { font-size:clamp(2rem,5vw,3.5rem); }
            textarea { font-size:clamp(1.05rem,2.2vw,1.2rem); min-height:100px; padding:14px; }
            select { font-size:0.95rem; padding:12px 40px 12px 14px; background-position:right 14px center; }
            .text-overlay { font-size:clamp(0.95rem,1.6vw,1.15rem); }
        }

        @media (max-width: 767px) {
            .main-card { padding:24px 16px; }
            .preview-section { min-height:300px; margin:22px 0; }
            .button-group { flex-direction:column; }
            button { width:100%; padding:12px 18px; }
            .input-section { margin:18px 0; display:block; }
            .color-palette { top:-340px; right:0; width:170px; }
            .color-option { width:36px; height:36px; }
            .color-picker-btn { font-size: clamp(0.72rem, 2.4vw, 0.86rem); padding: 6px 10px; }
        }

        @media (max-width: 480px) {
            .container { padding:12px; }
            .main-card { padding:18px 12px; border-radius:12px; }
            .preview-section { min-height:260px; }
            .placeholder { padding:60px 12px; }
            .color-picker-btn { font-size: 0.75rem; padding:6px 10px; }
            .color-swatch { width:12px; height:12px; }
            .text-overlay { width:90%; }
        }

        .loading { opacity:0.5; pointer-events:none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="logo">Festival Greetings</h1>
            <div class="divider"></div>
        </header>

        <div class="main-card">
            <div class="select-wrapper">
                <label class="select-label">Select Festival Template</label>
                <select id="templateSelect">
                    <option value="">Choose a celebration...</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Bhai Dooj.jpg">Bhai Dooj</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Buddha Purnima.jpg">Buddha Purnima</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Childrens Day.jpg">Children's Day</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Christmas.jpg">Christmas</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Diwali.jpg">Diwali</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Dusshera.jpg">Dusshera</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Ganesh Chaturthi.jpg">Ganesh Chaturthi</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Good Friday.jpg">Good Friday</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Govardhan Pooja.jpg">Govardhan Pooja</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Guru Nanak Jayanti.jpg">Guru Nanak Jayanti</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Independance Day.jpg">Independence Day</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Janmashtami.jpg">Janmashtami</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Labour Day.jpg">Labour Day</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Mahavir Jayanti.jpg">Mahavir Jayanti</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Makar Sankranti.jpg">Makar Sankranti</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Onam.jpg">Onam</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Raksha Bandhan.jpg">Raksha Bandhan</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Republic Day.jpg">Republic Day</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Teachers Day.jpg">Teachers Day</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Eid.jpg">Eid</option>
                    <option value="Sun_Sompraz Calendar_Greeting_Holi.jpg">Holi</option>
                    <option value="Sun_Sompraz Calendar_Greeting_New Year.jpg">New Year</option>
                </select>
            </div>

            <div class="preview-section" id="previewSection">
                <div class="placeholder">
                    <div class="placeholder-icon">✨</div>
                    <p class="placeholder-text">Begin Your Journey</p>
                    <p class="placeholder-subtext">Select a template to craft your perfect greeting</p>
                </div>
            </div>

            <div class="input-section" id="inputSection">
                <div class="input-header">
                    <div style="position: relative; display: flex; align-items: center; gap:10px;">
                        <!-- Text Color button (with small swatch) -->
                        <button class="color-picker-btn" id="colorPickerBtn" title="Choose text color">
                            <span class="color-swatch" id="colorSwatch" style="background:#1a1a2e"></span>
                            <span>Text Color</span>
                        </button>

                        <div class="color-palette" id="colorPalette" aria-hidden="true">
                            <div class="color-option active" data-color="#1a1a2e" style="background-color: #1a1a2e;" title="Dark"></div>
                            <div class="color-option" data-color="#ffffff" style="background-color: #ffffff;" title="White"></div>
                            <div class="color-option" data-color="#D4AF37" style="background-color: #D4AF37;" title="Gold"></div>

                            <div class="color-option" data-color="#ff6b6b" style="background-color: #ff6b6b;" title="Red"></div>
                            <div class="color-option" data-color="#ff4757" style="background-color: #ff4757;" title="Red Dark"></div>
                            <div class="color-option" data-color="#ff8a80" style="background-color: #ff8a80;" title="Red Light"></div>

                            <div class="color-option" data-color="#4ecdc4" style="background-color: #4ecdc4;" title="Teal"></div>
                            <div class="color-option" data-color="#2d9999" style="background-color: #2d9999;" title="Teal Dark"></div>
                            <div class="color-option" data-color="#7dd3c0" style="background-color: #7dd3c0;" title="Teal Light"></div>

                            <div class="color-option" data-color="#ffe66d" style="background-color: #ffe66d;" title="Yellow"></div>
                            <div class="color-option" data-color="#ffd93d" style="background-color: #ffd93d;" title="Yellow Dark"></div>
                            <div class="color-option" data-color="#fff4a3" style="background-color: #fff4a3;" title="Yellow Light"></div>

                            <div class="color-option" data-color="#a8e6cf" style="background-color: #a8e6cf;" title="Mint"></div>
                            <div class="color-option" data-color="#6fda9f" style="background-color: #6fda9f;" title="Mint Dark"></div>
                            <div class="color-option" data-color="#d5f5e3" style="background-color: #d5f5e3;" title="Mint Light"></div>

                            <div class="color-option" data-color="#ff8b94" style="background-color: #ff8b94;" title="Pink"></div>
                            <div class="color-option" data-color="#ff6b82" style="background-color: #ff6b82;" title="Pink Dark"></div>
                            <div class="color-option" data-color="#ffb3ba" style="background-color: #ffb3ba;" title="Pink Light"></div>

                            <div class="color-option" data-color="#9b59b6" style="background-color: #9b59b6;" title="Purple"></div>
                            <div class="color-option" data-color="#7d3c98" style="background-color: #7d3c98;" title="Purple Dark"></div>
                            <div class="color-option" data-color="#c39bd3" style="background-color: #c39bd3;" title="Purple Light"></div>

                            <div class="color-option" data-color="#3498db" style="background-color: #3498db;" title="Blue"></div>
                            <div class="color-option" data-color="#2980b9" style="background-color: #2980b9;" title="Blue Dark"></div>
                            <div class="color-option" data-color="#85c1e2" style="background-color: #85c1e2;" title="Blue Light"></div>
                        </div>
                    </div>
                </div>

                <textarea id="customText" placeholder="Write your name here..." maxlength="30"></textarea>
                <div class="char-count"><span id="charCount">0</span> / 30 characters</div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="downloadBtn" disabled><span>Download Greeting</span></button>
                <button class="btn-secondary" id="resetBtn"><span>Start Fresh</span></button>
            </div>

            <div class="success-message" id="successMessage">
                <span class="success-icon">✓</span>
                Your beautiful greeting has been saved successfully!
            </div>
        </div>
    </div>

    <script>
        // --- Constants: keep these consistent for preview and download ---
        const TEXT_Y_PERCENT = 0.91;   // 91% down the image height (same fraction used in canvas)
        const FONT_DIVISOR = 20;       // font size = imageWidth / FONT_DIVISOR (same logic for canvas & preview)

        const templateSelect = document.getElementById('templateSelect');
        const previewSection = document.getElementById('previewSection');
        const inputSection = document.getElementById('inputSection');
        const customText = document.getElementById('customText');
        const charCount = document.getElementById('charCount');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const successMessage = document.getElementById('successMessage');
        const colorPickerBtn = document.getElementById('colorPickerBtn');
        const colorPalette = document.getElementById('colorPalette');
        const colorOptions = document.querySelectorAll('.color-option');
        const colorSwatch = document.getElementById('colorSwatch');

        let selectedTemplate = null;
        let selectedTextColor = '#1a1a2e';
        let selectedFont = "'Quicksand', sans-serif";
        let selectedFontWeight = 700;

        // Color picker toggle
        colorPickerBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            colorPalette.classList.toggle('show');
        });

        // Close palettes when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.color-picker-btn') && !e.target.closest('.color-palette')) {
                colorPalette.classList.remove('show');
            }
        });

        // Color selection
        colorOptions.forEach(option => {
            option.addEventListener('click', (ev) => {
                colorOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedTextColor = option.dataset.color;
                // update swatch
                if (colorSwatch) colorSwatch.style.background = selectedTextColor;
                colorPalette.classList.remove('show');

                if (selectedTemplate) showPreview();
            });
        });

        // Template selection
        templateSelect.addEventListener('change', (e) => {
            const value = e.target.value;
            if (value) {
                selectedTemplate = value;
                inputSection.style.display = 'block';
                downloadBtn.disabled = false;
                showPreview();
            } else {
                resetPreview();
            }
        });

        // simple helper: compute font size like canvas uses
        function computeFontSizeForImage(imgEl) {
            const displayWidth = imgEl.clientWidth || imgEl.naturalWidth || 600;
            return Math.max(12, Math.floor(displayWidth / FONT_DIVISOR));
        }

        // Position overlay as percentage of the displayed image
        function overlayPositionHandler(imgEl, overlayEl, opts = {}) {
            if (!imgEl || !overlayEl) return;
            const yPercent = (opts.yPercent !== undefined) ? opts.yPercent : TEXT_Y_PERCENT;
            const fontDivisor = (opts.fontDivisor !== undefined) ? opts.fontDivisor : FONT_DIVISOR;

            // top expressed as percentage of image container
            overlayEl.style.top = `${yPercent * 100}%`;
            // center overlay vertically at that anchor (canvas uses textBaseline 'middle')
            overlayEl.style.transform = 'translate(-50%, -50%)';

            // font size similar to canvas
            const computedFontSize = computeFontSizeForImage(imgEl);
            overlayEl.style.fontSize = `${computedFontSize}px`;
            overlayEl.style.lineHeight = `${Math.round(computedFontSize * 1.4)}px`;

            // width constraints and wrapping
            overlayEl.style.width = '85%';
            overlayEl.style.whiteSpace = 'pre-wrap';
            overlayEl.style.wordBreak = 'break-word';
        }

        // Show preview (fully responsive; positions at TEXT_Y_PERCENT)
        function showPreview() {
            const text = customText.value || '';
            const templateName = templateSelect.options[templateSelect.selectedIndex]?.text || '';

            previewSection.innerHTML = `
                <div class="preview-container">
                    <img src="img/${selectedTemplate}" alt="${templateName}" class="preview-image" onerror="handleImageError(this)">
                    ${text ? `<div class="text-overlay" style="color: ${selectedTextColor}; font-family: ${selectedFont}; font-weight: ${selectedFontWeight};">${escapeHtml(text)}</div>` : ''}
                </div>
            `;

            const imgEl = previewSection.querySelector('.preview-image');
            const overlayEl = previewSection.querySelector('.text-overlay');

            if (!overlayEl) return;

            const applyPosition = () => overlayPositionHandler(imgEl, overlayEl, { yPercent: TEXT_Y_PERCENT, fontDivisor: FONT_DIVISOR });

            // If image already loaded
            if (imgEl.complete && imgEl.naturalHeight !== 0) {
                requestAnimationFrame(applyPosition);
            } else {
                imgEl.addEventListener('load', () => {
                    requestAnimationFrame(applyPosition);
                }, { once: true });
            }

            // keep single resize handler (remove previous if exists)
            if (showPreview._resizeHandler) {
                window.removeEventListener('resize', showPreview._resizeHandler);
            }
            showPreview._resizeHandler = () => {
                clearTimeout(showPreview._resizeTimeout);
                showPreview._resizeTimeout = setTimeout(() => {
                    applyPosition();
                }, 80);
            };
            window.addEventListener('resize', showPreview._resizeHandler);
        }

        // minimal HTML escaping for overlay text to avoid breaking SVG fallback
        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, function (m) {
                return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
            });
        }

        // Handle image error — produce a fallback SVG with template name
        window.handleImageError = function(img) {
            const templateName = templateSelect.options[templateSelect.selectedIndex]?.text || 'Template';
            img.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='1200' viewBox='0 0 1200 1200'%3E%3Crect fill='%231a1a2e' width='1200' height='1200'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23D4AF37' font-size='48' font-family='Arial'%3E${encodeURIComponent(templateName)}%3C/text%3E%3C/svg%3E`;
            // re-apply preview adjustments once fallback loaded
            img.addEventListener('load', () => {
                if (selectedTemplate) showPreview();
            }, { once: true });
        };

        // Reset preview to placeholder
        function resetPreview() {
            previewSection.innerHTML = `
                <div class="placeholder">
                    <div class="placeholder-icon">✨</div>
                    <p class="placeholder-text">Begin Your Journey</p>
                    <p class="placeholder-subtext">Select a template to craft your perfect greeting</p>
                </div>
            `;
            inputSection.style.display = 'none';
            downloadBtn.disabled = true;
            // cleanup resize handler if any
            if (showPreview._resizeHandler) {
                window.removeEventListener('resize', showPreview._resizeHandler);
                showPreview._resizeHandler = null;
            }
        }

        // Update character count and preview
        customText.addEventListener('input', (e) => {
            charCount.textContent = e.target.value.length;
            if (selectedTemplate) showPreview();
        });

        // DOWNLOAD: uses same percentage + font logic so output matches preview
        downloadBtn.addEventListener('click', () => {
            if (!selectedTemplate) return;
            downloadBtn.classList.add('loading');

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            // If templates are on same origin, this is fine. If loading cross-origin images,
            // you'd need proper CORS headers and img.crossOrigin = 'anonymous';
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;

                // Draw image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                // Draw text (if any)
                const text = customText.value;
                if (text) {
                    // font matches preview calculation
                    const fontSize = Math.floor(canvas.width / FONT_DIVISOR);
                    // attempt to use font family; canvas might fallback if webfont not loaded
                    const fontFamily = selectedFont.replace(/'/g, '');
                    ctx.font = `bold ${fontSize}px ${fontFamily}`;
                    ctx.fillStyle = selectedTextColor;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';

                    // text shadow for readability
                    ctx.shadowColor = 'rgba(255,255,255,0.5)';
                    ctx.shadowBlur = 4;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 2;

                    // word wrap using the same 85% width
                    const maxWidth = canvas.width * 0.85;
                    const lineHeight = fontSize * 1.6;
                    const x = canvas.width / 2;
                    const y = Math.round(canvas.height * TEXT_Y_PERCENT);

                    const words = text.split(' ');
                    let line = '';
                    let lines = [];

                    words.forEach(word => {
                        const testLine = line + word + ' ';
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && line !== '') {
                            lines.push(line.trim());
                            line = word + ' ';
                        } else {
                            line = testLine;
                        }
                    });
                    if (line) lines.push(line.trim());

                    const startY = y - ((lines.length - 1) * lineHeight) / 2;
                    lines.forEach((ln, i) => {
                        ctx.fillText(ln, x, startY + (i * lineHeight));
                    });
                }

                // Export
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const templateName = templateSelect.options[templateSelect.selectedIndex].text || 'greeting';
                    a.href = url;
                    a.download = `${templateName.replace(/\s+/g, '-')}-greeting.png`;
                    a.click();
                    URL.revokeObjectURL(url);

                    downloadBtn.classList.remove('loading');

                    // success feedback
                    successMessage.classList.add('show');
                    setTimeout(() => successMessage.classList.remove('show'), 3000);
                });
            };

            img.onerror = () => {
                downloadBtn.classList.remove('loading');
                alert('Failed to load the image for export. Check that img/' + selectedTemplate + ' exists and is accessible.');
            };

            img.src = `img/${selectedTemplate}`;
        });

        // Reset functionality
        resetBtn.addEventListener('click', () => {
            templateSelect.value = '';
            customText.value = '';
            charCount.textContent = '0';
            selectedTemplate = null;
            selectedTextColor = '#1a1a2e';
            selectedFont = "'Quicksand', sans-serif";
            selectedFontWeight = 700;

            colorOptions.forEach(opt => opt.classList.remove('active'));
            colorOptions[0]?.classList.add('active');

            if (colorSwatch) colorSwatch.style.background = selectedTextColor;

            customText.style.fontFamily = selectedFont;
            customText.style.fontWeight = selectedFontWeight;

            resetPreview();
            successMessage.classList.remove('show');
        });

        // initialize (ensure placeholder visible)
        resetPreview();
    </script>
</body>
</html>
